name: Build Win7 32 Executable

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Python 3.7.9 (x86)
      uses: actions/setup-python@v4
      with:
        python-version: '3.7.9'
        architecture: 'x86'

    - name: Configure Environment
      shell: powershell
      run: |
        # 获取Python路径（强制ASCII编码）
        $pythonPath = (Get-Command python).Path
        Write-Host "Python Path: $pythonPath"

        # 计算Scripts目录（禁用特殊字符）
        $scriptsDir = Join-Path (Split-Path $pythonPath -Parent) "Scripts"
        Write-Host "Scripts Dir: $scriptsDir"

        # 设置环境变量（仅英文符号）
        $env:PATH = "$scriptsDir;$env:PATH"
        Write-Host "Updated PATH: $env:PATH"

        # 调试：验证路径存在
        Test-Path "$scriptsDir\pyinstaller.exe"

    - name: Install Dependencies
      shell: powershell
      run: |
        # 降级pip（无特殊字符命令）
        python -m pip install --upgrade "pip<21.0"

        # 安装依赖（版本严格匹配）
        pip install pyinstaller==4.10 pywin32==227 pandas==1.3.5 numpy==1.21.6 pygame==2.5.2 importlib-metadata==4.8.1

    - name: Copy VC++ Redist
      shell: bash
      run: |
        cp ./deps/vc_redist.x86.exe ${{ github.workspace }}/vc_redist.x86.exe
        # 验证文件哈希（必须添加）
        echo "b84d8443f15c5eae8cd66d383cb6a28c6b1d7316db494ceea4792a42b83d0e0c  vc_redist.x86.exe" | sha256sum -c
    
    - name: Build Executable
      shell: powershell
      run: |
        pyinstaller --onefile --noconsole ` 
          --add-data "resources/pop.wav;resources" `
          --add-data "vc_redist.x86.exe;." `  # 添加VC++安装程序
          --hidden-import pandas._libs.tslibs.np_datetime `
          --hidden-import pandas._libs.tslibs.nattype `
          --hidden-import pygame._sdl2 `
          --hidden-import importlib_metadata `
          --runtime-tmpdir . `
          --arch x86 ` # 明确指定32位架构
          bubble_app.py

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: win7-32-exe
        path: dist/bubble_app.exe
